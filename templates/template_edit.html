{% extends "base.html" %}
{% from "_components.html" import topbar, btn, flash_messages, card %}
{% from "_form_macros.html" import task_row %}

{% block content %}
{% set _tpl = template|default({'id': 0, 'name': '', 'notes': '', 'sections': []}) %}
{% set _icons = icons|default([]) %}
<div class="max-w-4xl mx-auto p-5">
  <script>
    // Provide template data to JS when needed (e.g., preserving image flair)
    window.__PREFILL_TEMPLATE = {{ _tpl|tojson|safe }};
    window.__ICONS = {{ _icons|tojson|safe }};
  </script>

  {{ topbar(
      title='Edit Template',
      actions=[
        {'label': '‚Üê Back', 'href': '/templates', 'variant': 'outline'},
        {'label': 'üè† Home', 'href': '/', 'variant': 'outline'},
      ],
      show_theme_toggle=True
  ) }}

  <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6">
    {{ flash_messages(get_flashed_messages(with_categories=true)) }}
    <form method="POST" action="/templates/{{ _tpl.id }}/update" id="taskForm" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-200">Name</label>
          <input type="text" name="name" value="{{ _tpl.name or '' }}" required class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-200">Notes (optional)</label>
          <input type="text" name="notes" value="{{ _tpl.notes or '' }}" class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600" />
        </div>
      </div>

      <div id="subtitleSections">
        {% for sec in (_tpl.sections or []) %}
        {% set i = loop.index %}
        <div class="subtitle-section border-b border-gray-200 dark:border-slate-700 pb-5 mb-7" data-section="{{ i }}">
          <label for="subtitle_{{ i }}" class="block mb-2 font-semibold text-gray-600 dark:text-gray-200">Subtitle (e.g., Cleaning kitchen):</label>
          <input type="text" id="subtitle_{{ i }}" name="subtitle_{{ i }}" value="{{ sec.subtitle or '' }}" class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600 mb-2" />
          <div class="taskContainer" id="taskContainer_{{ i }}">
            {% for t in (sec.tasks or []) %}
              {% set j = loop.index %}
              {{ task_row(i, j, _icons, text=t.text or '', flair_type=(t.flair_type or 'none'), flair_value=t.flair_value) }}
              {# Preserve existing image flair path if present and no new upload provided #}
              {% if t.flair_type == 'image' and t.flair_value %}
                <input type="hidden" name="flair_image_existing_{{ i }}_{{ j }}" value="{{ t.flair_value }}" />
              {% endif %}
            {% endfor %}
          </div>
          <button type="button" class="add-task-btn w-full py-2.5 rounded-md bg-green-600 text-white hover:bg-green-700">‚ûï Add Task</button>
        </div>
        {% endfor %}
      </div>

      <button type="button" class="w-full py-2.5 rounded-md bg-brand text-white hover:bg-brand-dark mb-7" onclick="TaskPrinter.addSubtitleSection()">‚ûï Add Subtitle Section</button>

      <div class="flex items-center justify-end gap-2">
        <a href="/templates" class="px-4 py-2 rounded-md border text-slate-700 dark:text-slate-200 dark:border-slate-600">Cancel</a>
        <button type="submit" class="px-5 py-2 rounded-md bg-brand text-white hover:bg-brand-dark">Save Changes</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
