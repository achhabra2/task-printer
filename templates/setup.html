{% extends "base.html" %} {% from "_components.html" import topbar, card, btn %} {% block content %}
<div class="max-w-4xl mx-auto p-5">
    {{ topbar(
        title="‚öôÔ∏è Task Printer Setup",
        actions=[
            {'label': '‚Üê Back', 'href': '/', 'variant': 'outline'},
            {'label': 'üßæ Jobs', 'href': '/jobs', 'variant': 'outline'},
            {'label': 'üìö Templates', 'href': '/templates', 'variant': 'outline'}
        ],
        show_theme_toggle=True
    ) }}

    <div class="flex items-center justify-end gap-2 my-3">
        {{ btn("üíæ Save & Start", variant="primary", size="sm", type="submit", id="saveStartBtn") }}
        {{ btn("üß™ Test Print", variant="secondary", size="sm", type="submit", formaction="/setup_test_print", id="testPrintBtn") }}
    </div>

  {% call card() %}
  <form method="POST" novalidate class="w-full">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

    {# Current printer type in config, default 'usb' #}
    {% set pt = (config.printer_type if config and config.printer_type else 'usb') %}

    <!-- Printer Type -->
    <label class="block font-semibold mt-4 mb-1 text-slate-700 dark:text-slate-200">Printer Type:</label>
    <select
      name="printer_type"
      id="printer_type"
      onchange="onTypeChange()"
      class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
    >
      <option value="usb" {% if pt == 'usb' %}selected{% endif %}>USB</option>
      <option value="network" {% if pt == 'network' %}selected{% endif %}>Network</option>
      <option value="serial" {% if pt == 'serial' %}selected{% endif %}>Serial</option>
    </select>

    <!-- Printer Profile -->
    <label class="block font-semibold mt-4 mb-1 text-slate-700 dark:text-slate-200">Printer Profile (optional):</label>
    {% set profiles = [
      ('', 'Generic (default)'),
      ('TM-P80', 'Epson TM-P80'),
      ('TM-T88III', 'Epson TM-T88III'),
      ('TM-T20III', 'Epson TM-T20III')
    ] %}
    {% set sel_profile = (config.printer_profile if config and config.printer_profile is not none else '') %}
    <select
      name="printer_profile"
      id="printer_profile"
      class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
    >
      {% for val, label in profiles %}
        <option value="{{ val }}" {% if sel_profile == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>

    <!-- USB Fields -->
    <label class="block font-bold mt-5 mb-2 text-left">Select your USB printer:</label>
    <div id="usb_fields" class="{% if pt != 'usb' %}hidden{% endif %}">
      <div class="text-left">
        {% if usb_devices and usb_devices|length > 0 %}
          {% for dev in usb_devices %}
            {% set is_selected = (config and pt == 'usb' and ('0x' ~ dev.vendor)|lower == (config.usb_vendor_id|default('')|lower) and ('0x' ~ dev.product)|lower == (config.usb_product_id|default('')|lower)) %}
            <div class="mb-3 flex items-start gap-2 text-left">
              <input class="mt-1.5 h-3.5 w-3.5" type="radio" name="usb_device" value="0x{{ dev.vendor }}:0x{{ dev.product }}" {% if is_selected %}checked{% endif %}>
              <label class="m-0 font-normal text-slate-800 dark:text-slate-200">
                {{ dev.desc }}
                {% if not dev.is_printer %}
                  <span class="text-slate-400 text-sm">(not a printer)</span>
                {% endif %}
                <span class="text-slate-500 text-sm">(Vendor ID: 0x{{ dev.vendor }}, Product ID: 0x{{ dev.product }})</span>
              </label>
            </div>
          {% endfor %}
          {% set cfg_vendor_no0x = (config.usb_vendor_id|default('')|lower|replace('0x','')) if config else '' %}
          {% set cfg_product_no0x = (config.usb_product_id|default('')|lower|replace('0x','')) if config else '' %}
          {% set matched = usb_devices | selectattr('vendor','equalto', cfg_vendor_no0x) | selectattr('product','equalto', cfg_product_no0x) | list %}
          <div class="mt-2 flex items-center gap-2 text-left">
            <input class="h-3.5 w-3.5" type="radio" name="usb_device" value="manual" {% if config and pt == 'usb' and (matched|length == 0) %}checked{% endif %}>
            <label class="font-normal m-0">Other (enter manually below)</label>
          </div>
        {% else %}
          {% set matched = [] %}
          <div class="text-slate-600 text-sm my-3">No USB printers detected. Please enter Vendor ID and Product ID manually below.</div>
        {% endif %}

        <!-- Manual USB fields -->
        <div id="manual_usb_fields" class="{% if (not usb_devices) or (config and pt == 'usb' and (matched|length == 0)) %}{% else %}hidden{% endif %} mt-3">
          <label class="block font-semibold mt-3 mb-1 text-slate-700 dark:text-slate-200">USB Vendor ID:</label>
          <input
            name="usb_vendor_id"
            value="{{ (config.usb_vendor_id if config else '0x04b8') }}"
            class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
          >
          <div class="text-slate-500 text-sm mb-2">Find this by running <code>lsusb</code> on your Raspberry Pi. Example: <code>ID 04b8:0e28</code> ‚Üí Vendor ID: <b>0x04b8</b></div>

          <label class="block font-semibold mt-3 mb-1 text-slate-700 dark:text-slate-200">USB Product ID:</label>
          <input
            name="usb_product_id"
            value="{{ (config.usb_product_id if config else '0x0e28') }}"
            class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
          >
          <div class="text-slate-500 text-sm">Find this by running <code>lsusb</code>. Example: <code>ID 04b8:0e28</code> ‚Üí Product ID: <b>0x0e28</b></div>
        </div>
      </div>
    </div>

    <!-- Formatting -->
    <div id="formatting_fields" class="mt-4">
      <label class="block font-semibold mb-1 text-slate-700 dark:text-slate-200">Receipt width (px):</label>
      <input
        type="number"
        name="receipt_width"
        min="280"
        max="1024"
        step="1"
        value="{{ (config.receipt_width if config and config.receipt_width is not none else 512) }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
      <div class="text-slate-500 text-sm mb-2">Common widths: 384 (58mm), 512 or 576 (80mm). Larger values increase text size automatically.</div>

      <label class="block font-semibold mb-1 text-slate-700 dark:text-slate-200">Blank lines before cut (0‚Äì10):</label>
      <input
        type="number"
        name="cut_feed_lines"
        min="0"
        max="10"
        value="{{ (config.cut_feed_lines if config and config.cut_feed_lines is not none else 2) }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
      <div class="text-slate-500 text-sm mb-2">Controls extra blank lines added at the end of each receipt before cutting.</div>

      <label class="flex items-center gap-2 font-normal mt-2 text-slate-800 dark:text-slate-200">
        <input class="h-4 w-4" type="checkbox" name="print_separators" {% if not config or config.print_separators %}checked{% endif %}>
        Print dashed separators around tasks
      </label>

      <label class="block font-semibold mt-4 mb-1 text-slate-700 dark:text-slate-200">Default tear-off delay (seconds)</label>
      <input
        type="number"
        name="default_tear_delay_seconds"
        min="0"
        max="60"
        step="0.5"
        value="{{ (config.default_tear_delay_seconds if config and config.default_tear_delay_seconds is not none else '') }}"
        placeholder="0 (disabled)"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
      <div class="text-slate-500 text-sm mb-2">If set, prints triggered from the Templates page will wait between tasks and not cut. The index page will preload this value but it can be changed per print.</div>
    </div>

    <!-- Flair layout tuning -->
    <div id="flair_fields" class="mt-4">
      <h3 class="mt-2 mb-2 text-slate-600 dark:text-slate-300 font-semibold">Flair Layout (optional)</h3>

      <label class="block font-semibold mb-1 text-slate-700 dark:text-slate-200">Separator width (px):</label>
      <input
        type="number"
        name="flair_separator_width"
        min="1"
        max="10"
        value="{{ (config.flair_separator_width if config and config.flair_separator_width is not none else 3) }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
      <div class="text-slate-500 text-sm mb-2">Thickness of the vertical line between text and icon (1‚Äì10).</div>

      <label class="block font-semibold mb-1 text-slate-700 dark:text-slate-200">Separator gap (px):</label>
      <input
        type="number"
        name="flair_separator_gap"
        min="0"
        max="64"
        value="{{ (config.flair_separator_gap if config and config.flair_separator_gap is not none else 14) }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
      <div class="text-slate-500 text-sm mb-2">Horizontal padding on both sides of the separator line (0‚Äì64).</div>

      <label class="block font-semibold mb-1 text-slate-700 dark:text-slate-200">Flair column width (px):</label>
      <input
        type="number"
        name="flair_col_width"
        min="96"
        max="512"
        value="{{ (config.flair_col_width if config and config.flair_col_width is not none else 256) }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
      <div class="text-slate-500 text-sm mb-2">Fixed width of the right column that holds the icon (96‚Äì512). Default 256.</div>

      <label class="block font-semibold mb-1 text-slate-700 dark:text-slate-200">Flair target height (px):</label>
      <input
        type="number"
        name="flair_target_height"
        min="96"
        max="512"
        value="{{ (config.flair_target_height if config and config.flair_target_height is not none else 256) }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
      <div class="text-slate-500 text-sm mb-2">Target height for the icon area; icon is centered within this height (96‚Äì512). Default 256.</div>

      <label class="block font-semibold mb-1 text-slate-700 dark:text-slate-200">Max icon upscale (√ó):</label>
      <input
        type="number"
        step="0.1"
        name="flair_icon_scale_max"
        min="1.0"
        max="4.0"
        value="{{ (config.flair_icon_scale_max if config and config.flair_icon_scale_max is not none else 2.0) }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
      <div class="text-slate-500 text-sm mb-2">Limit how much smaller icons may be upscaled (1.0‚Äì4.0). Default 2.0.</div>

      <label class="block font-semibold mb-1 text-slate-700 dark:text-slate-200">Minimum text width (px):</label>
      <input
        type="number"
        name="min_text_width"
        min="100"
        value="{{ (config.min_text_width if config and config.min_text_width is not none else (config.receipt_width * 0.45 if config and config.receipt_width else 230)) }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
      <div class="text-slate-500 text-sm">Guarantee at least this width for the text column. If the text would be narrower, the icon area shrinks slightly to compensate.</div>
    </div>

    <!-- Live Preview -->
    <div class="mt-5 border border-slate-200 dark:border-slate-700 rounded-lg p-3 bg-slate-50 dark:bg-slate-900/40">
      <div class="overflow-auto">
        <canvas
          id="flairPreview"
          class="bg-white border border-dashed border-slate-300 rounded-md w-full h-auto"
          width="{{ (config.receipt_width if config and config.receipt_width else 512) }}"
          height="360"
        ></canvas>
      </div>
      <div class="flex flex-col gap-2 mt-3">
        <div class="flex gap-2 flex-wrap">
          <input
            type="text"
            id="previewText"
            placeholder="Sample task text‚Ä¶"
            value="Sample Task Text can wrap to multiple lines for preview"
            class="flex-1 min-w-[260px] p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
          >
          <select
            id="previewIcon"
            class="p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
          >
            <option value="">(no icon)</option>
            {% for ic in icons %}
              <option value="{{ url_for('static', filename=ic.filename) }}">{{ ic.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="text-slate-500 text-xs">Preview is approximate (browser rendering); printer output may vary slightly.</div>
      </div>
    </div>

    <!-- Network Fields -->
    <div id="network_fields" class="{% if pt != 'network' %}hidden{% endif %} mt-4">
      <label class="block font-semibold mb-1 text-slate-700 dark:text-slate-200">Network IP:</label>
      <input
        name="network_ip"
        value="{{ (config.network_ip if config else '') }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
      <label class="block font-semibold mt-3 mb-1 text-slate-700 dark:text-slate-200">Network Port:</label>
      <input
        name="network_port"
        value="{{ (config.network_port if config else '9100') }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
    </div>

    <!-- Serial Fields -->
    <div id="serial_fields" class="{% if pt != 'serial' %}hidden{% endif %} mt-4">
      <label class="block font-semibold mb-1 text-slate-700 dark:text-slate-200">Serial Port:</label>
      <input
        name="serial_port"
        value="{{ (config.serial_port if config else '') }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
      <label class="block font-semibold mt-3 mb-1 text-slate-700 dark:text-slate-200">Serial Baudrate:</label>
      <input
        name="serial_baudrate"
        value="{{ (config.serial_baudrate if config else '19200') }}"
        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
      >
    </div>

    <hr class="my-6 border-t border-slate-200 dark:border-slate-700" />

    <!-- Auto startup -->
    <div class="flex items-center gap-2 text-left">
      <input class="h-4 w-4" type="checkbox" name="auto_startup" id="auto_startup">
      <label for="auto_startup" class="font-bold">Enable auto startup on boot (systemd)</label>
    </div>

    <!-- Buttons -->
    <div class="mt-5 grid grid-cols-1 sm:grid-cols-3 gap-3">
      {{ btn("Save & Start", variant="primary", size="lg", type="submit", id="saveStartBtn") }}
      {{ btn("üß™ Test Print", variant="secondary", size="lg", type="submit", formaction="/setup_test_print", id="testPrintBtn") }}
      {% if show_close %}
        {{ btn("Close", variant="ghost", size="lg", id="closeBtn") }}
      {% endif %}
    </div>
  </form>
  {% endcall %}
</div>

<script>
  // Helpers
  function showId(id) { var el = document.getElementById(id); if (el) el.classList.remove('hidden'); }
  function hideId(id) { var el = document.getElementById(id); if (el) el.classList.add('hidden'); }

  // Toggle sections based on printer type
  function onTypeChange() {
    var t = document.getElementById('printer_type').value;
    if (t === 'usb') {
      showId('usb_fields'); hideId('network_fields'); hideId('serial_fields');
    } else if (t === 'network') {
      hideId('usb_fields'); showId('network_fields'); hideId('serial_fields');
    } else if (t === 'serial') {
      hideId('usb_fields'); hideId('network_fields'); showId('serial_fields');
    }
  }

  function onUsbRadioChange() {
    var checked = document.querySelector('input[name=usb_device]:checked');
    if (checked && checked.value === 'manual') showId('manual_usb_fields');
    else hideId('manual_usb_fields');
  }

  function getInt(name, defVal) {
    var el = document.querySelector('input[name="'+name+'"]');
    if (!el) return defVal;
    var v = parseInt(el.value, 10);
    if (isNaN(v)) return defVal;
    return v;
  }
  function getFloat(name, defVal) {
    var el = document.querySelector('input[name="'+name+'"]');
    if (!el) return defVal;
    var v = parseFloat(el.value);
    if (isNaN(v)) return defVal;
    return v;
  }

  function drawPreview() {
    var canvas = document.getElementById('flairPreview');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var desiredW = getInt('receipt_width', canvas.width);
    if (desiredW !== canvas.width) { canvas.width = desiredW; }
    var W = canvas.width, H = canvas.height;
    
    // Clear canvas
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, W, H);
    
    // Layout constants (match server values)
    var leftMargin = 10, rightMargin = 10, topMargin = 20, extraSpacing = 10;
    var sepWidth = getInt('flair_separator_width', 3);
    var gapSep = getInt('flair_separator_gap', 14);
    var gapBeforeSep = gapSep;
    var gapAfterSep = gapSep;
    var flairContentTarget = getInt('flair_col_width', 256);
    var flairTargetH = getInt('flair_target_height', 256);
    
    // Calculate minimum text width (match server calculation)
    var minTextWidth = getInt('min_text_width', Math.max(180, Math.floor(W * 0.45)));
    
    // Total flair block width (match server calculation)
    var flairBlockWidth = gapBeforeSep + sepWidth + gapAfterSep + flairContentTarget;
    
    // Calculate text column width
    var textColWidth = W - leftMargin - rightMargin - flairBlockWidth;
    
    // Adjust flair content target if text would be too cramped (match server logic)
    if (textColWidth < minTextWidth) {
      var delta = minTextWidth - textColWidth;
      flairContentTarget = Math.max(128, flairContentTarget - delta);
      flairBlockWidth = gapBeforeSep + sepWidth + gapAfterSep + flairContentTarget;
      textColWidth = W - leftMargin - rightMargin - flairBlockWidth;
      textColWidth = Math.max(textColWidth, 1);
      flairContentTarget = Math.max(flairContentTarget, 1);
    }
    
    // Wrap text using adjusted text width
    var text = document.getElementById('previewText').value || '';
    ctx.fillStyle = '#000';
    ctx.font = 'bold 20px sans-serif';
    
    function measure(str) { return ctx.measureText(str).width; }
    
    var words = text.split(/\s+/);
    var lines = [], cur = '';
    for (var i = 0; i < words.length; i++) {
      var test = cur ? (cur + ' ' + words[i]) : words[i];
      if (measure(test) <= textColWidth) {
        cur = test;
      } else {
        if (cur) lines.push(cur);
        cur = words[i];
      }
    }
    if (cur) lines.push(cur);
    
    var lineH = 28;
    var textBlockH = topMargin * 2 + (lineH + extraSpacing) * Math.max(1, lines.length);
    var flairTotalH = topMargin * 2 + flairTargetH;
    var outH = Math.max(textBlockH, flairTotalH);
    
    // Resize canvas if needed
    if (H !== outH) {
      canvas.height = outH;
      H = outH;
      ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = '#000';
      ctx.font = 'bold 20px sans-serif';
    }
    
    // Draw text
    var y = topMargin + lineH;
    for (var j = 0; j < lines.length; j++) {
      ctx.fillText(lines[j], leftMargin, y);
      y += lineH + extraSpacing;
    }
    
    // Anchor positions to the right (match server logic)
    var flairRight = W - rightMargin;
    var flairLeft = flairRight - flairContentTarget;
    
    // Draw separator (match server positioning)
    var sepXLeft = flairLeft - gapBeforeSep - sepWidth;
    sepXLeft = Math.max(leftMargin, Math.min(sepXLeft, W - rightMargin - sepWidth));
    ctx.fillRect(sepXLeft, topMargin, sepWidth, H - topMargin * 2);
    
    // Draw icon if selected
    var iconUrl = document.getElementById('previewIcon').value;
    if (iconUrl) {
      var img = new Image();
      img.onload = function() {
        // Clear and redraw base
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, W, H);
        ctx.fillStyle = '#000';
        ctx.font = 'bold 20px sans-serif';
        
        // Redraw text
        var y2 = topMargin + lineH;
        for (var k = 0; k < lines.length; k++) {
          ctx.fillText(lines[k], leftMargin, y2);
          y2 += lineH + extraSpacing;
        }
        
        // Redraw separator
        ctx.fillRect(sepXLeft, topMargin, sepWidth, H - topMargin * 2);
        
        // Scale icon to match server logic
        var fw = Math.max(1, img.width);
        var fh = Math.max(1, img.height);
        var ratioW = flairContentTarget / fw;
        var ratioH = flairTargetH / fh;
        var baseRatio = Math.min(ratioW, ratioH);
        var maxScale = getFloat('flair_icon_scale_max', 2.0);
        var ratio = Math.max(0.01, Math.min(baseRatio, Math.max(1.0, maxScale)));
        ratio = Math.min(ratio, baseRatio); // Allow downscale if needed
        
        var newW = Math.max(1, Math.round(fw * ratio));
        var newH = Math.max(1, Math.round(fh * ratio));
        
        // Center flair in content area (match server centering)
        var flairX = flairLeft + Math.max(0, Math.floor((flairContentTarget - newW) / 2));
        var flairY = topMargin + Math.max(0, Math.floor((H - topMargin * 2 - newH) / 2));
        
        // Clamp to canvas bounds
        flairX = Math.max(0, Math.min(flairX, W - newW));
        flairY = Math.max(0, Math.min(flairY, H - newH));
        
        ctx.drawImage(img, flairX, flairY, newW, newH);
      };
      img.src = iconUrl;
    }
  }

  window.onload = function() {
    onTypeChange();
    var radios = document.querySelectorAll('input[name=usb_device]');
    for (var i=0; i<radios.length; ++i) { radios[i].addEventListener('change', onUsbRadioChange); }
    onUsbRadioChange();

    var closeBtn = document.getElementById('closeBtn');
    if (closeBtn) {
      closeBtn.addEventListener('click', function(){ window.location.href = '/'; });
    }

    // preview bindings
    ['receipt_width','flair_separator_width','flair_separator_gap','flair_col_width','flair_target_height','min_text_width'].forEach(function(name){
      var el = document.querySelector('input[name="'+name+'"]');
      if (el) el.addEventListener('input', drawPreview);
    });
    var t = document.getElementById('previewText');
    if (t) t.addEventListener('input', drawPreview);
    var iconSel = document.getElementById('previewIcon');
    if (iconSel) iconSel.addEventListener('change', drawPreview);
    // initial draw
    drawPreview();
  };
</script>
{% endblock %}
