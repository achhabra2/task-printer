{% extends "base.html" %} {% from "_components.html" import topbar, btn,
flash_messages, card, flash %} {% block content %} {% from "_form_macros.html"
import task_row, flair_row, icon_picker %}
<div class="max-w-4xl mx-auto p-5">
    {% if prefill_template %}
    <script>
        window.__PREFILL_TEMPLATE = {{ prefill_template|tojson|safe }};
    </script>
    {% endif %}
    <script>
        window.__ICONS = [
          {% for ic in icons %}{ name: "{{ ic.name }}", url: "{{ url_for('static', filename=ic.filename) }}" }{% if not loop.last %},{% endif %}{% endfor %}
        ];
    </script>
    <!-- Health badge sits above the top bar to avoid interfering with buttons -->
    <div class="flex justify-end mt-3">
        <span id="healthStatus" class="px-2 py-1 rounded text-xs bg-slate-200 text-slate-800 dark:bg-slate-700 dark:text-slate-200">Health: ‚Ä¶</span>
    </div>

    <div class="flex items-center justify-between gap-2 my-4 flex-wrap">
        <div class="flex items-center gap-2 flex-wrap">
            {{ btn("üßæ Jobs", href="/jobs", variant="outline", size="sm") }} {{
            btn("üìö Templates", href="/templates", variant="outline", size="sm")
            }} {{ btn("‚öôÔ∏è Settings", href="/setup", variant="outline",
            size="sm") }} {{ btn("‚ùì Help", href="/help", variant="outline",
            size="sm") }}
        </div>
        <div class="flex items-center gap-2 flex-wrap">
            {{ btn("üíæ Save as Template", variant="primary", size="sm",
            id="saveTplBtn") }}
            <form method="POST" action="/test_print" class="inline m-0 p-0">
                <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                />
                {{ btn("üß™ Test Print", variant="secondary", size="sm",
                type="submit") }}
            </form>
            {{ btn("üåô Dark Mode", variant="ghost", size="sm", id="darkModeBtn")
            }}
        </div>
    </div>
    <script>
        (function () {
            var saveBtn = document.getElementById("saveTplBtn");
            if (saveBtn) {
                saveBtn.addEventListener("click", function () {
                    if (typeof saveCurrentAsTemplate === "function") {
                        saveCurrentAsTemplate();
                    }
                });
            }
            var themeBtn = document.getElementById("darkModeBtn");
            if (themeBtn) {
                function syncLabel() {
                    var dark =
                        document.documentElement.classList.contains("dark");
                    themeBtn.textContent = dark
                        ? "‚òÄÔ∏è Light Mode"
                        : "üåô Dark Mode";
                }
                syncLabel();
                themeBtn.addEventListener("click", function () {
                    if (typeof window.toggleDarkMode === "function")
                        window.toggleDarkMode();
                    setTimeout(syncLabel, 0);
                });
            }
        })();
    </script>

    <!-- Card container -->
    <div class="bg-white dark:bg-slate-800 p-7 rounded-md shadow">
        {% if prefill_template %} {{ flash('info', 'Loaded template: ' ~
        (prefill_template.name or '')) }} {% endif %}
        <h1
            class="text-center text-2xl font-bold text-slate-800 dark:text-slate-100 mb-6"
        >
            üìã Task Printer
        </h1>

        {% if job_id %}
        <!-- Job banner -->
        <div
            id="jobStatus"
            data-job-id="{{ job_id }}"
            class="flex items-center gap-2 p-2.5 rounded border-l-4 bg-blue-50 border-blue-600 text-blue-900 dark:bg-slate-700 dark:text-blue-300 dark:border-blue-400 mb-4"
        >
            <strong>Job {{ job_id[:8] }}</strong>
            <span id="jobStatusText">Checking‚Ä¶</span>
            <button
                type="button"
                id="jobDismissBtn"
                aria-label="Dismiss"
                class="ml-auto bg-transparent border-0 text-slate-600 hover:text-slate-900 dark:text-slate-300 dark:hover:text-white"
            >
                ‚úï
            </button>
        </div>
        {% endif %}

        <!-- Flash Messages -->
        {{ flash_messages(get_flashed_messages(with_categories=true)) }}

        <!-- Task Input Form -->
        <form method="POST" id="taskForm" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div id="categorySections">
                {% if prefill_template and prefill_template.sections %} {% for
                sec in prefill_template.sections %} {% set i = loop.index %}
                <div
                    class="category-section border-b border-gray-200 dark:border-slate-700 pb-5 mb-7"
                    data-section="{{ i }}"
                >
                    <label
                        for="category_{{ i }}"
                        class="block mb-2 font-semibold text-gray-600 dark:text-gray-200"
                        >Category (e.g., Home, Work, Project ABC):</label
                    >
                    <input
                        type="text"
                        id="category_{{ i }}"
                        name="category_{{ i }}"
                        placeholder="Enter category..."
                        value="{{ sec.category or '' }}"
                        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600 mb-2"
                    />
                    <div class="taskContainer" id="taskContainer_{{ i }}">
                        {% for t in (sec.tasks or []) %} {% set j = loop.index
                        %} {{ task_row(i, j, icons, text=t.text or '',
                        flair_type=(t.flair_type or 'none'),
                        flair_value=t.flair_value) }} {% endfor %}
                    </div>
                    <button
                        type="button"
                        class="add-task-btn w-full py-2.5 rounded-md bg-green-600 text-white hover:bg-green-700"
                    >
                        ‚ûï Add Task
                    </button>
                </div>
                {% endfor %} {% else %}
                <div
                    class="category-section border-b border-gray-200 dark:border-slate-700 pb-5 mb-7"
                    data-section="1"
                >
                    <label
                        for="category_1"
                        class="block mb-2 font-semibold text-gray-600 dark:text-gray-200"
                        >Category (e.g., Home, Work, Project ABC):</label
                    >
                    <input
                        type="text"
                        id="category_1"
                        name="category_1"
                        placeholder="Enter category..."
                        class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600 mb-2"
                    />
                    <div class="taskContainer" id="taskContainer_1">
                        {{ task_row(1, 1, icons) }}
                    </div>
                    <button
                        type="button"
                        class="add-task-btn w-full py-2.5 rounded-md bg-green-600 text-white hover:bg-green-700"
                    >
                        ‚ûï Add Task
                    </button>
                </div>
                {% endif %}
            </div>
            <button
                type="button"
                class="w-full py-2.5 rounded-md bg-brand text-white hover:bg-brand-dark mb-7"
                onclick="TaskPrinter.addCategorySection()"
            >
                ‚ûï Add Category
            </button>
            <!-- Print Options: Tear-off delay -->
            <div class="mb-4">
                <label
                    for="tear_delay_seconds"
                    class="block mb-1 font-semibold text-gray-600 dark:text-gray-200"
                    >Tear-off delay (seconds)</label
                >
                <input
                    type="number"
                    id="tear_delay_seconds"
                    name="tear_delay_seconds"
                    min="0"
                    max="60"
                    step="0.5"
                    placeholder="0 (disabled)"
                    value="{% if default_tear_delay and default_tear_delay > 0 %}{{ (default_tear_delay|int) if default_tear_delay == (default_tear_delay|int) else default_tear_delay }}{% endif %}"
                    class="w-full p-2.5 border-2 rounded-md text-sm bg-white text-gray-900 border-gray-300 focus:outline-none focus:border-brand dark:bg-slate-800 dark:text-gray-100 dark:border-slate-600"
                />
                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                    Wait this many seconds between tasks and do not cut.
                </p>
            </div>
            <button
                type="submit"
                class="w-full py-4 rounded-md text-lg bg-brand text-white hover:bg-brand-dark"
            >
                Print Tasks
            </button>
        </form>
    </div>
</div>

{% endblock %}
