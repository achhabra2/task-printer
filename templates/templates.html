{% extends "base.html" %} {% from "_components.html" import topbar, btn,
flash_messages, card %} {% block content %}
<div class="max-w-4xl mx-auto p-5">
    {{ topbar( title='Templates', actions=[ {'label': '‚Üê Back', 'href': '/',
    'variant': 'outline'}, {'label': 'üßæ Jobs', 'href': '/jobs', 'variant':
    'outline'}, {'label': '‚öôÔ∏è Settings', 'href': '/setup', 'variant': 'outline'}
    ], show_theme_toggle=True ) }} {{
    flash_messages(get_flashed_messages(with_categories=true)) }}

    <!-- Card -->
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-5">
        {% if not templates %}
        <div class="text-center text-slate-500 py-8">
            <div class="text-lg mb-1">No templates yet</div>
            <div>Create one from the main page using ‚ÄúSave as Template‚Äù.</div>
        </div>
        {% else %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-slate-100 dark:bg-slate-700">
                        <th class="text-left px-2.5 py-2 w-[40%]">Name</th>
                        <th class="text-left px-2.5 py-2 hidden sm:table-cell">
                            Counts
                        </th>
                        <th class="text-left px-2.5 py-2 hidden sm:table-cell">
                            Updated
                        </th>
                        <th class="text-left px-2.5 py-2">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in templates %}
                    <tr
                        class="border-b border-gray-200 dark:border-slate-700"
                        data-template-id="{{ t.id }}"
                        data-template-name="{{ t.name }}"
                    >
                        <td class="px-2.5 py-2 align-top">
                            <div
                                class="font-semibold text-slate-900 dark:text-slate-100"
                            >
                                {{ t.name }}
                            </div>
                            {% if t.notes %}
                            <div
                                class="text-xs text-slate-500 dark:text-slate-300 mt-1"
                                title="{{ t.notes|e }}"
                            >
                                {{ t.notes }}
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-2.5 py-2 align-top hidden sm:table-cell">
                            <span
                                class="text-xs text-slate-500 dark:text-slate-300"
                            >
                                {{ t.sections_count }} section{{ '' if
                                t.sections_count == 1 else 's' }}, {{
                                t.tasks_count }} task{{ '' if t.tasks_count == 1
                                else 's' }}
                            </span>
                        </td>
                        <td class="px-2.5 py-2 align-top hidden sm:table-cell">
                            <span
                                class="text-xs text-slate-500 dark:text-slate-300"
                            >
                                {{ (t.updated_at or t.created_at) or '' }}
                            </span>
                        </td>
                        <td class="px-2.5 py-2 align-top">
                            <div class="flex flex-wrap gap-2">
                                {{ btn("üì• Load", variant="secondary",
                                size="sm", onclick="loadFromBtn(this)") }}

                                <form
                                    class="inline-block"
                                    method="POST"
                                    action="/templates/{{ t.id }}/print"
                                >
                                    <input
                                        type="hidden"
                                        name="csrf_token"
                                        value="{{ csrf_token() }}"
                                    />
                                    {{ btn("üñ®Ô∏è Print", variant="primary",
                                    size="sm", type="submit") }}
                                </form>

                                {{ btn("‚éò Duplicate", variant="outline",
                                size="sm", onclick="duplicateFromBtn(this)") }}
                                {{ btn("üóëÔ∏è Delete", variant="danger", size="sm",
                                onclick="deleteFromBtn(this)") }}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Helper: read CSRF from cookie (flask-wtf sets csrf_token cookie on safe responses)
    function getCookie(name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length === 2) {
            return decodeURIComponent(parts.pop().split(";").shift());
        }
        return "";
    }
    function csrfHeader(headers) {
        headers = headers || {};
        const token = getCookie("csrf_token");
        if (token) headers["X-CSRFToken"] = token;
        return headers;
    }

    // Button handlers that pull data from the row dataset to avoid inline JSON
    function rowFor(el) {
        return el && el.closest ? el.closest("tr[data-template-id]") : null;
    }
    function duplicateFromBtn(el) {
        var row = rowFor(el);
        if (!row) return;
        var id = parseInt(row.getAttribute("data-template-id"), 10);
        var name = row.getAttribute("data-template-name") || "";
        return duplicateTemplate(id, name);
    }
    function deleteFromBtn(el) {
        var row = rowFor(el);
        if (!row) return;
        var id = parseInt(row.getAttribute("data-template-id"), 10);
        var name = row.getAttribute("data-template-name") || "";
        return deleteTemplate(id, name);
    }
    function loadFromBtn(el) {
        var row = rowFor(el);
        if (!row) return;
        var id = parseInt(row.getAttribute("data-template-id"), 10);
        return loadToForm(id);
    }

    function duplicateTemplate(id, currentName) {
        var base = (currentName || "Template").trim();
        var newName = prompt(
            "Duplicate as (leave empty to auto-suffix):",
            base + " Copy"
        );
        var payload = newName ? { new_name: newName } : {};
        return fetch("/templates/" + id + "/duplicate", {
            method: "POST",
            headers: csrfHeader({
                "Content-Type": "application/json",
                Accept: "application/json"
            }),
            body: JSON.stringify(payload)
        })
            .then(function (res) {
                if (!res.ok)
                    return res
                        .json()
                        .catch(function () {
                            return {};
                        })
                        .then(function (err) {
                            throw new Error(err.error || res.statusText);
                        });
                location.reload();
            })
            .catch(function (e) {
                alert("Duplicate failed: " + e);
            });
    }

    function deleteTemplate(id, name) {
        if (!confirm("Delete template ‚Äú" + name + "‚Äù? This cannot be undone."))
            return;
        return fetch("/templates/" + id + "/delete", {
            method: "POST",
            headers: csrfHeader({ Accept: "application/json" }),
        })
            .then(function (res) {
                if (!res.ok)
                    return res
                        .json()
                        .catch(function () {
                            return {};
                        })
                        .then(function (err) {
                            throw new Error(err.error || res.statusText);
                        });
                var row = document.querySelector(
                    'tr[data-template-id="' + id + '"]',
                );
                if (row) row.remove();
                if (document.querySelectorAll("tbody tr").length === 0)
                    location.reload();
            })
            .catch(function (e) {
                alert("Delete failed: " + e);
            });
    }

    function loadToForm(id) {
        return fetch("/templates/" + id, {
            headers: { Accept: "application/json" },
        })
            .then(function (res) {
                if (!res.ok)
                    return res
                        .json()
                        .catch(function () {
                            return {};
                        })
                        .then(function (err) {
                            throw new Error(err.error || res.statusText);
                        });
                return res.json();
            })
            .then(function (data) {
                try {
                    localStorage.setItem(
                        "taskprinter:prefill_template",
                        JSON.stringify(data)
                    );
                } catch (e) { /* ignore */ }
                // Also include a server-side prefill hint for robust fallback
                location.href = "/?prefill=" + encodeURIComponent(id);
            })
            .catch(function (e) {
                alert("Load failed: " + e);
            });
    }

    function safeJson(res) {
        return res.json().catch(function () {
            return {};
        });
    }
</script>
{% endblock %}
